# 01-Context 組裝（packing）與引用格式

## 你將學到（Learning Objectives）

- 知道「把 chunks 塞進 prompt」不是越多越好
- 能把 evidence 轉成 LLM 友善且可引用的 context
- 能設計引用格式，支援審計與回放

## 本章地圖

- **適合用在**：答案引用不穩、context 太長太亂、LLM 常抓錯重點時。
- **你會做出**：context packing 流程與可審計的引用格式。
- **最可能踩雷**：塞越多越好；引用格式不固定導致回放困難與假引用。

## Context packing 在解什麼問題

檢索拿到的是「候選片段」，但生成需要的是：

- 足夠、但不冗餘的證據
- 彼此不要重複太多
- 保留關鍵語境（標題、條款、例外條件）
- 可引用（能回到來源）

## packing 的基本流程（推薦）

1. **去重**：相同或高度相似 chunks 只留一份
2. **多樣性控制**：必要時用 MMR 或規則（避免都來自同一段）
3. **截斷策略**：保留關鍵句，避免超長
4. **引用標籤**：給每個 chunk 一個 citation id（如 [S1] [S2]）
5. **輸出格式固定**：讓 LLM 容易引用與遵循

## 建議的引用格式（起手式）

每個 chunk 建議提供：

- citation id：`[S1]`
- 人類可讀來源：文件名/章節/頁碼/URL
- 內容：chunk_text

範例：

```text
[S1] 內規手冊 / 請假 / 病假（p.12） source: https://...
（chunk_text...）

[S2] 內規手冊 / 請假 / 特休（p.10） source: https://...
（chunk_text...）
```

## 最終輸出與引用規則

建議在 prompt 明確要求：

- 每個結論都要引用至少一個 [Sx]
- 若證據不足：必須「拒答」或「提出澄清問題」
- 禁止引用不存在的來源（避免「假引用」）

## 本章小結

- context packing 的目標是「足夠但不冗餘」：去重、多樣性控制、截斷與固定格式。
- 引用格式要同時滿足人讀與機器回放：citation id + 可追溯來源 + chunk 內容。
- 在 prompt 內強制：每個結論要引用、證據不足要拒答/追問、禁止假引用。

## 延伸閱讀

- [02-Prompt模板（可回答-不可回答-追問澄清）](02-Prompt模板（可回答-不可回答-追問澄清）.md)
- [03-可觀測性：log-trace-命中率-失敗分類](../06-評估與觀測（讓工程團隊能迭代）/03-可觀測性：log-trace-命中率-失敗分類.md)
