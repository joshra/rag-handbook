# 03-降低幻覺的防線（guardrails / 證據不足處理）

## 你將學到（Learning Objectives）

- 知道幻覺的常見來源：證據不足、證據雜訊、模型補完
- 能建立多層防線：檢索、生成、後處理、觀測迴圈
- 能設計「證據不足」的明確處理方式（拒答/追問/降級）

## 本章地圖

- **適合用在**：上線後最怕的兩件事：硬答幻覺、越權外洩。
- **你會做出**：證據不足處理、引用強制、提示注入基本防護。
- **最可能踩雷**：只靠 prompt 口頭約束；沒有 trace 回放導致無法定位問題。

## 幻覺通常不是單點問題

常見情況：

- retrieval 沒召回正確證據 → 模型只好猜（高幻覺）
- chunk 太雜 → 模型抓錯句子當依據
- prompt 沒限制 → 模型自然會補完

所以 guardrails 要「分層」做。

## 防線 1：檢索層（最有效）

- 權限與版本 filter 正確（避免越權與資料污染）
- top-k 合理、加入多路召回
- rerank 提升最終 evidence 品質

## 防線 2：生成層（規則化輸出）

- 強制引用（每個結論都引用）
- 定義不可回答條件（證據不足就拒答/追問）
- 把「證據」與「指令」分離（抵禦提示注入）

## 防線 3：後處理（可選，但很實用）

- 檢查引用是否存在（禁止假引用）
- 檢查輸出是否越權（例如包含不該出現的敏感詞）
- 若偵測到高風險：改成拒答或只回傳引用片段

## 證據不足：三種策略（建議）

- **拒答**：說明缺什麼證據/條件
- **追問澄清**：只問 1～2 個關鍵條件，再重新檢索
- **降級回覆**：提供最相關引用片段，但不下結論（視產品需求）

## 你需要的觀測（否則 guardrails 無法迭代）

- 哪些問題被拒答？原因是什麼（無證據/矛盾/越權）
- 幻覺案例的失敗分類（retrieval miss vs generation）
- 引用命中率（引用是否真的支持答案）

## 本章小結

- 降低幻覺要多層防線：檢索品質、context packing、引用強制、拒答/追問、輸出驗證。
- 證據不足要明確拒答或追問，不能用語氣把不確定包裝成肯定。
- 提示注入要用「把證據當資料」的方式處理，並把權限與 system prompt 隔離。

## 延伸閱讀

- [03-Metadata與權限欄位設計（ACL-租戶隔離）](../02-資料工程（最容易踩雷的地方）/03-Metadata與權限欄位設計（ACL-租戶隔離）.md)
- [03-可觀測性：log-trace-命中率-失敗分類](../06-評估與觀測（讓工程團隊能迭代）/03-可觀測性：log-trace-命中率-失敗分類.md)
- [05-安全合規：PII-權限-審計-提示注入防護](../07-工程化與上線（Django+Postgres實作）/05-安全合規：PII-權限-審計-提示注入防護.md)
