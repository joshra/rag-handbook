# 01-Query 改寫 / 擴展（rewrite / expand）

## 你將學到（Learning Objectives）

- 知道 query 改寫在 RAG 中的目的：提升召回率、降低歧義
- 能判斷什麼時候該改寫，什麼時候不該（避免改壞）
- 能在不綁供應商的前提下設計 query pipeline

## 本章地圖

- **適合用在**：使用者問題太短/太口語，導致檢索 miss 或召回太雜時。
- **你會做出**：query 正規化、改寫與擴展策略（含安全邊界）。
- **最可能踩雷**：改寫引入幻覺或越權；改寫結果不納入 trace 回放。

## 為什麼要改寫

使用者的問題常常：

- 太短（「怎麼做？」）
- 缺少關鍵上下文（部門/產品/版本/條款）
- 含口語（與文件用語不一致）

改寫的目標：把 query 變成「更接近文件語言」與「可檢索」的形式。

## 常見做法

### 1) 規則型正規化（起手式）

- 全形半形、空白、標點統一
- 常見縮寫正規化（KPI/ACL/PRD 等）

### 2) 同義詞/術語擴展（推薦）

- 建立一份「你們領域的術語表」：產品名、內部代號、簡稱
- 以字典方式 expand（成本低、可控）

### 3) LLM rewrite（要可控）

LLM 可把口語改寫成「更像文件的問法」。

風險：
- 可能改錯意思（尤其 query 很短時）

建議：
- rewrite 只產生「檢索 query」，不要直接拿來回答
- 觀測 rewrite 前後的 retrieval 命中差異

## 追問澄清（比改寫更重要的場合）

當問題缺乏關鍵條件時，最好的策略常常是：

- 先問 1～2 個澄清問題（例如「你指的是 A 產品還是 B 產品？」）
- 再檢索與回答

這比「模型猜測」更能提升正確率與信任。

## 本章小結

- rewrite/expand 的目標是把「人話」轉成「可檢索的 query」，並控制其風險。
- 改寫必須可觀測：原 query、改寫後 query、使用的版本與耗時都要能回放。
- 安全邊界優先：改寫不能引入不存在的實體或擴大權限範圍。

## 延伸閱讀

- [02-top-k-filter-MMR-多路召回](02-top-k-filter-MMR-多路召回.md)
- [03-降低幻覺的防線（guardrails-證據不足處理）](../05-生成策略（把答案變可靠）/03-降低幻覺的防線（guardrails-證據不足處理）.md)
- [03-可觀測性：log-trace-命中率-失敗分類](../06-評估與觀測（讓工程團隊能迭代）/03-可觀測性：log-trace-命中率-失敗分類.md)
