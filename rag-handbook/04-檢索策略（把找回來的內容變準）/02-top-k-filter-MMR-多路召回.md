# 02-top-k / filter / MMR / 多路召回

## 你將學到（Learning Objectives）

- 能理解 top-k、filters、MMR 對檢索結果的影響
- 能用多路召回把「不漏」與「不亂」做出平衡
- 能把權限/租戶 filter 當成檢索的硬規則，而不是可選項

## 本章地圖

- **適合用在**：要把線上檢索調到「不漏且不亂」，並能控制成本/延遲時。
- **你會做出**：top-k 起手式、filters 分類、MMR 與多路召回流程。
- **最可能踩雷**：filters 不當成硬規則；k 值過大導致 rerank/LLM 成本爆炸。

## top-k：取多少才對

直覺：
- k 太小 → 容易漏掉答案證據（recall 低）
- k 太大 → 雜訊多、rerank/LLM 成本高（precision 低）

起手式（可調）：
- 向量召回 k = 20～50
- 最終給 LLM 的引用 chunks = 4～10（依 prompt/輸出格式而定）

## filters：為什麼是「上線必備」

filters 常見類型：

- **安全 filters（必套用）**：tenant_id、ACL、機密等級
- **產品 filters（可選）**：doc_type、日期範圍、資料版本、來源

重點：filter 不是「後處理」，而是「檢索查詢的一部分」。

## MMR：避免 top-k 太像

MMR 的目的：
- 在「相關性」與「多樣性」間折衷

適用情境：
- 同一份文件多個 chunk 很相似，top-k 都被同一段落附近佔滿

副作用：
- 有時會把真正最相關的結果往後推（因此通常搭配 rerank）

## 多路召回：最穩的上線套路

推薦流程：

- 向量召回：top-k1
- 全文召回：top-k2（若有）
- 規則召回：關鍵字/條款編號/型號（若需要）
- 合併去重 → 候選集合
- rerank → 最終 top-n

這個流程的好處：
- 第一階段求「不漏」
- 第二階段求「變準」

## 本章小結

- top-k 是 recall 與成本/延遲的交易：先用起手式，再用離線集與 trace 調參。
- filters 分成安全（必套用）與產品（可選）；安全 filter 必須在查詢內導入。
- 多路召回先求不漏，再靠 rerank 求變準；合併去重是穩定性的關鍵細節。

## 延伸閱讀

- [03-Rerank（二階段檢索）與常見模型](03-Rerank（二階段檢索）與常見模型.md)
- [03-Metadata與權限欄位設計（ACL-租戶隔離）](../02-資料工程（最容易踩雷的地方）/03-Metadata與權限欄位設計（ACL-租戶隔離）.md)
