# 03-混合檢索（BM25 + 向量）與何時要用

## 你將學到（Learning Objectives）

- 知道為什麼「只用向量」常常不穩
- 能判斷哪些 query 適合全文檢索、哪些適合向量、哪些要混合
- 能規劃混合檢索落地方式：多路召回 → merge → rerank

## 本章地圖

- **適合用在**：有大量精確術語/型號/條款編號，純向量容易漏時。
- **你會做出**：向量 + FTS/BM25 的多路召回與合併去重流程。
- **最可能踩雷**：只做 hybrid 不做 rerank；兩路結果合併沒去重/沒權限 filter。

## 什麼是混合檢索

混合檢索通常指：

- **關鍵字/全文檢索（BM25-ish）**：擅長精確字串、術語、編號、型號
- **向量檢索**：擅長語意近似、同義句、描述性問題

把兩者合併，能顯著提升「不漏」與「不亂」的穩定性。

## 什麼情況強烈建議混合

- 問題含 **條款編號/規格型號/代碼/縮寫**（例如「3.2.1」「ABC-123」）
- 文件中有大量 **專有名詞**（向量可能會把它當普通詞）
- 中文文件含大量「精確字串」需求（人名、產品名、版本號）

## 落地策略（推薦）

### 1) 多路召回（最常見）

- 向量 top-k1
- 全文 top-k2
- 合併去重 → 得到候選集合
- rerank（強烈建議）→ 取最終 top-n 給 LLM

### 2) 分流（query routing）

如果你想省成本：
- 先判斷 query 是否像「精確字串」→ 用全文
- 否則用向量

但要小心：分流判斷錯會造成漏召回，通常建議先用多路召回起步。

## 用 PostgreSQL 做全文檢索（概念）

Postgres 內建全文檢索可以作為起手式：
- 你可以先做「全文召回」
- 再跟向量召回合併（或只用全文作補強）

若之後需要更完整的搜尋能力，再導入 Elastic/OpenSearch 也很常見。

## 本章小結

- 混合檢索的核心是「不漏」：關鍵字擅長精確命中，向量擅長語意相近。
- 合併召回後要去重並保留來源/分數，才能做可解釋的 rerank 與回放。
- 上線通常以 hybrid + rerank 更穩，尤其在規格/條款/代碼語料。

## 延伸閱讀

- [03-Rerank（二階段檢索）與常見模型](../04-檢索策略（把找回來的內容變準）/03-Rerank（二階段檢索）與常見模型.md)
- [02-PostgreSQL+pgvector落地（schema-索引-查詢樣式）](../07-工程化與上線（Django+Postgres實作）/02-PostgreSQL+pgvector落地（schema-索引-查詢樣式）.md)
