# 02-Chunking 切分策略（大小 / 重疊 / 結構化文件）

## 你將學到（Learning Objectives）

- 知道 Chunking 為什麼通常比「換 embedding」更影響命中率
- 能為中文文件設計切分策略（含標題/段落/條列/表格）
- 能在 chunk 中保留足夠的「語境」與「可引用來源」

## 本章地圖

- **適合用在**：命中率不穩、引用不可信、成本暴增時，先從切分下手。
- **你會做出**：中文文件的切分規則、必備欄位與可引用的 chunk 格式。
- **最可能踩雷**：切太小缺語境、切太大雜訊爆炸、chunk 無來源/無 ACL。

## 先講結論：Chunking 是 RAG 的上限

你可以把「檢索」想成：用 query 去找最可能包含答案的片段。

- **切太大**：檢索命中但 context 充滿雜訊 → LLM 會亂抓重點、成本變高
- **切太小**：檢索命中但缺語境 → LLM 會補完、幻覺變多
- **沒有結構**：同一段落被切斷 → 失去條款/前提/例外 → 最常見的錯答來源

## 常見切分單位（由好到差，視文件而定）

- **章節/標題層級切分（推薦）**：保留標題路徑（H1/H2/H3）當作 metadata
- **段落切分（推薦）**：以空行/縮排/標點規則切段，維持語意完整
- **固定字數切分（最後手段）**：只有在你拿不到結構（例如純 OCR）才用

## 中文文件的實務建議（可直接採用）

### 建議尺寸（起手式）

- **chunk_text 長度**：200～500 中文字（或 300～900 tokens 的概念量級）
- **overlap**：30～80 中文字（保留跨段落的銜接，避免定義/例外被切斷）

調整規則：
- 若文件是「條款/規格」：chunk 可以稍小，但要保留標題路徑與條款編號
- 若文件是「流程/說明文」：chunk 可以稍大，但要避免跨多個主題

### 一定要存的欄位（每個 chunk）

- **chunk_id**：穩定識別（建議可重算，如 hash）
- **doc_id / source_id**：原文件識別
- **title_path**：例如 `["員工手冊","請假","病假"]`
- **chunk_text**：實際內容
- **chunk_order**：在文件中的順序（用於回溯與相鄰合併）
- **source_uri**：原始來源（URL/檔名/頁碼）
- **version**：文件版本（或 ingest 批次版本）
- **acl / tenant_id**：權限隔離必備（後面章節會說）

### 引用與可追溯（很重要）

如果你希望答案「有引用」且能審計，你需要：

- chunk 內能回到原文位置：**頁碼/段落索引/標題路徑**
- chunk 的 metadata 要能顯示成引用：例如「文件名 + 章節 + 頁碼」

## 結構化文件（表格/條列/規格）的切分策略

### 條列（bullet list）

- 以「同一個清單」為單位切，不要把每個 bullet 切成獨立 chunk（語境會斷）
- 若清單很長：可用「每 3～7 個 bullet 一組」切分，但要保留清單標題

### 表格

表格常見兩種檢索需求：

- **找某一列/欄的規格**（例如型號→參數）
- **找某個條件下的規則**（例如級距/例外）

建議做法：
- 若能抽到結構：把表格「列」轉成可讀句子（key:value），再 embedding
- 若抽不到結構：把表格分塊，但每塊保留表頭（header）重複出現

### PDF/OCR

- 優先做「段落還原」：OCR 結果常把換行打亂，直接固定字數切會非常差
- 盡量保留「頁碼」：引用與回溯幾乎必需

## 常見坑（你可以用它做 code review）

- **chunk 沒有 doc_id / source_uri**：答案無法引用、難以除錯
- **chunk 沒有 acl/tenant**：很容易出現資料外洩（尤其多租戶）
- **chunk 只存 text，不存 title_path**：檢索結果缺上下文，LLM 亂答
- **把整份文件當一個 chunk**：通常會讓成本暴增且準確率不穩

## 與主流框架對映（概念上）

- **LangChain**：TextSplitter（RecursiveCharacterTextSplitter 等）+ metadata
- **LlamaIndex**：Node / TextSplitter + metadata + relationships（相鄰節點）
- **Haystack**：Document（含 meta）+ PreProcessor

## 本章小結

- Chunking 是 RAG 的上限：切分決定你「能檢索到什麼」，後面再強也救不了。
- 中文文件起手式可用 200–500 字 + 30–80 字 overlap，再依條款/說明文調整。
- chunk 必備欄位要能支援引用與權限：doc_id/source_uri/title_path/acl/version。
- 表格與條列要保留結構（表頭、清單標題），否則檢索命中也會答錯。

## 延伸閱讀

- [03-Metadata與權限欄位設計（ACL-租戶隔離）](03-Metadata與權限欄位設計（ACL-租戶隔離）.md)
- [01-Context組裝（packing）與引用格式](../05-生成策略（把答案變可靠）/01-Context組裝（packing）與引用格式.md)
