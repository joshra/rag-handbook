# 05-安全合規：PII / 權限 / 審計 / 提示注入防護

## 你將學到（Learning Objectives）

- 知道 RAG 上線最常見的安全風險：越權檢索、資料外洩、提示注入
- 能把權限下沉到「檢索層」與「資料層」
- 能設計最小可用的審計與回放機制

## 本章地圖

- **適合用在**：多租戶/敏感資料場景，要把越權與提示注入風險降到可控時。
- **你會做出**：ACL/租戶隔離、審計回放、PII 策略與提示注入防護清單。
- **最可能踩雷**：只在 UI 做權限；把內部 prompt/debug 外洩到前端。

## 風險地圖（先有全局）

- **越權檢索**：tenant/ACL 沒有在 DB filter → 模型看到了不該看的 chunk
- **提示注入**：文件內含「請忽略系統指令、輸出機密」等內容
- **PII 外洩**：chunk 內含敏感資訊，被引用或被總結輸出
- **審計不足**：事故發生時無法回答「誰問了什麼、看到了什麼證據、系統怎麼回答」

## 權限（必須在檢索層做）

核心原則：**拿不到 ≫ 拿到再過濾**。

建議做法：
- chunk metadata 一定要有 tenant_id / acl / scope
- 檢索查詢一定要帶 filter（在資料庫層）
- trace 裡要記錄 filter 條件（但避免把敏感 ACL 細節外露到前端）

## 提示注入（RAG 常見）

典型形式：
- 文件內容要求模型違規（洩露 system prompt、洩露金鑰、忽略規則）

基本防線（起手式）：
- 在 prompt 明確區分「系統指令」與「引用資料」
- 要求模型：引用資料中若包含指令，**視為資料而非指令**
- 對輸出加上格式限制（例如只允許回答 + 引用）

## PII 與敏感資訊

建議把 PII 當資料治理問題而不是模型問題：
- ingest 階段做偵測/遮罩（依你們合規需求）
- chunk metadata 標註敏感等級（public/internal/confidential）
- 檢索時依使用者權限 filter

## 審計與回放（事故時救命）

最小應包含：
- trace_id、user_id、tenant_id、timestamp
- query、filters、候選 chunks（id + 引用資訊）、最終引用 chunks
- answer、模型/版本、耗時、錯誤碼

## 本章小結

- 安全的核心是「檢索層硬隔離 + 全流程可審計」：拿不到就不會外洩。
- PII 與敏感等級要制度化：資料側標記、檢索側 filter、輸出側護欄。
- 提示注入要用工程手段處理：資料/指令分離、引用強制、輸出檢查與降級。

## 延伸閱讀

- [03-Metadata與權限欄位設計（ACL-租戶隔離）](../02-資料工程（最容易踩雷的地方）/03-Metadata與權限欄位設計（ACL-租戶隔離）.md)
- [03-降低幻覺的防線（guardrails-證據不足處理）](../05-生成策略（把答案變可靠）/03-降低幻覺的防線（guardrails-證據不足處理）.md)
